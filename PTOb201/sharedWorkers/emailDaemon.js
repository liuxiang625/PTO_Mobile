/*** @author admin*//*	Here, we add the "onconnect" function to this worker (== to this .js file)	It's in this function that we receive messages from other threads, other workers,	asking us to do something*///onconnect = function(msg) // called when a new SharedWorker is created.//{function onconnect(msg) {	// In a SharedWorker, we get the communication port in evt.ports[0]    var thePort = msg.ports[0];       thePort.onmessage = function(messageEvt)    {    	var sessionRef = currentSession(); // Get session.		var promoteToken = sessionRef.promoteWith("Administrator"); //temporarily make this session Admin level.	    	// The message is in the "data" member of the argument		var message = messageEvt.data;       	// The caller is supposed to have set a "what" property, to tell us what		// he wants us to do. We dispatch the message and act accordingly.		// Notice that the caller can set more properties in messageEvt.				switch(message.what) 		{			case 'responsiveApplications':			var username = 'wakandaptodemo'; // enter a valid account here			var password = 'wakandave';  // enter a valid password here			var address = 'smtp.gmail.com';			var port = 465;  // SSL port			var mail = require('waf-mail/mail');			var recip = "dave@wakanda.org";						var mailMessage = new mail.Mail();			mailMessage.setBodyType("text/html");			mailMessage.from= username + '@gmail.com';			mailMessage.to=recip;			mailMessage.subject = "Wakanday 2012";			mailMessage.setBody('<html><b>Using Shared Workers To Improve Application Responsiveness</b><br/><br/><b>Preference</b> '+ message.name + ': ' + message.value + '</html>'); 			mailMessage.send(address, port , true, username, password);			break;									case 'htmlEmailTest':			var username = 'wakandaptodemo'; // enter a valid account here			var password = 'wakandave';  // enter a valid password here			var address = 'smtp.gmail.com';			var port = 465;  // SSL port			var mail = require('waf-mail/mail');			var recip = "dave@wakanda.org";						var mailMessage = new mail.Mail();			mailMessage.setBodyType("text/html");			mailMessage.from= username + '@gmail.com';			mailMessage.to=recip;			mailMessage.subject = "Wakanday 2012";			mailMessage.setBody('<html><b>Lesser Know Features</b><br/>But soon you will know...<br/><br/>The color is: '+ message.color + '</html>'); 			mailMessage.send(address, port , true, username, password);			break;									case 'requestTimeOff':			try 			{				var theRequestor = ds.User(message.requestorID),					requestLineItems = message.requestLineItems,					notes = message.notes,					firstDayOff = message.firstDayOff,					lastDayOff = message.lastDayOff,					myManager = theRequestor.myManager,					myManagerEmail = myManager.email,					ptoID = message.ptoID,					approvePassword = message.approvePassword,					approveID = message.approveID,					messageBody;								/**/				var username = 'wakandaptodemo'; // enter a valid account here				var password = 'wakandave';  // enter a valid password here				var address = 'smtp.gmail.com';				var port = 465;  // SSL port								var mail = require('waf-mail/mail');				var recip = new Array(myManagerEmail);								//message body start				messageBody = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">';				messageBody += '<html>';				messageBody += '<head>';				messageBody += '<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />';				messageBody += '<title>PTO Request</title>';				messageBody += '<style type="text/css">';								messageBody += 'ul {';				messageBody += 'list-style: none;';				messageBody += '}';								messageBody += 'a {';				messageBody += 'text-decoration: none;';				messageBody += 'font-weight: bold;';				messageBody += 'color: #6699CC;';				messageBody += '}';								messageBody += '#wrapDiv {';				messageBody += 'width: 100%;';				messageBody += 'background-color:#FFFFFF;';				messageBody += 'border:1px solid #DFDFDF;';				messageBody += 'padding: 3px;';				messageBody += 'color: #202020;';				messageBody += 'font-size: 14px;';				messageBody += '}';				messageBody += '#bannerDiv {';				messageBody += 'background-color:#B0C4DE;';				messageBody += 'color: #FFFFFF;';				messageBody += 'padding: 5px 30px;';				messageBody += 'font-size:22px;';				messageBody += '}';								messageBody += '#messageDiv {';				messageBody += 'padding: 10px';				messageBody += '}';								messageBody += '#notesDiv {';				messageBody += 'background-color:#F0F8FF;';				messageBody += 'padding: 5px;';				messageBody += 'border: 1px solid gray;';				messageBody += '}';				messageBody += '</style>';				messageBody += '</head>';								messageBody += '<body>';				messageBody += '<div id="wrapDiv">';				messageBody += '<div id="bannerDiv">';				messageBody += '<p>';				messageBody += '4D US - Paid Time Off';				messageBody += '</p>';				messageBody += '</div>';								messageBody += '<div id="messageDiv">';				messageBody += '<p>';				messageBody += myManager.fullName ;				messageBody += '</p>';				messageBody += '<p>';				messageBody += '<strong>';				messageBody += theRequestor.fullName;				messageBody += '</strong>';				messageBody += " has requested time off from ";				messageBody += firstDayOff + " to " + lastDayOff + ".";				messageBody += '</p>';								messageBody += '<ul>';				var lineItemText;				requestLineItems.forEach(function(lineItem) {					if (lineItem.compensation === "Paid Time Off") {						lineItemText = lineItem.dateRequested + ": " + lineItem.compensation + "  " + lineItem.hoursRequested;					} else {						lineItemText = lineItem.dateRequested + ": " + lineItem.compensation;					}										messageBody += '<li>';					messageBody += lineItemText;					messageBody += '</li>';				});				messageBody += '</ul>';								messageBody += '<div id="notesDiv">';				messageBody += "<p>";				messageBody += notes;				messageBody += "</p>";				messageBody += "</div>";				messageBody += "<p>";								//messageBody += '<a href="http://' + httpServer.hostName + ':' + httpServer.port +'">4D PTO</a>';				messageBody += '<a href="http://' + httpServer.ipAddress + ':' + httpServer.port +'">4D PTO</a>';								messageBody += "</p>";				messageBody += "<p>";								//var ptoApprovalURL = "http://" + httpServer.hostName + ":" + httpServer.port + "/ptoApproval/" + ptoID + "/" + approvePassword + "/" + approveID + "/approve";				var ptoApprovalURL = "http://" + httpServer.ipAddress + ":" + httpServer.port + "/ptoApproval/" + ptoID + "/" + approvePassword + "/" + approveID + "/approve";								messageBody += '<a href="' + ptoApprovalURL + '">Approve PTO</a>';				messageBody += "</p>";				messageBody += '</div>';								messageBody += '</div>';				messageBody += '</body>';				messageBody += '</head>';				messageBody += '</html>';				//end message body								var messageSubject = "PTO request " + ptoID + " from " + theRequestor.fullName;									var mailMessage = new mail.Mail();				mailMessage.setBodyType("text/html");				mailMessage.from = 'wakandaptodemo@gmail.com';				mailMessage.to = recip;				mailMessage.subject = messageSubject;				mailMessage.setBody(messageBody); // that's all				mailMessage.send(address, port , true, username, password);				//... end new mail module again.																//mail.send('smtp.gmail.com', 465, true, 'wakandaptodemo', 'Wakanda2013', 'wakandaptodemo@gmail.com', rec, messageSubject, messageBody);			}						catch (err)			{				//debugger;				new ds.Log({					createDate: new Date(), 					message: err.message,					line: err.line,					name: err.name,					sourceID: err.sourceID,					sourceURL: err.sourceURL				}).save();			}			break;						case 'requestApproved':						try 			{				var theRequestor = ds.User(message.requestorID);				var notes = message.notes;				var status = message.status;				var requestLineItems = message.requestLineItems;				var firstDayOff = message.firstDayOff;				var lastDayOff = message.lastDayOff;				var myManager = theRequestor.myManager;				var requestorEmail = theRequestor.email;				var messageBody;								//New Mail Module...				/*				var username = 'drobbins'; // enter a valid account here				var password = '???';  // enter a valid password here				var address = 'exchange.4d.com';				*/								/**/				var username = 'wakandaptodemo'; // enter a valid account here				var password = 'wakandave';  // enter a valid password here				var address = 'smtp.gmail.com';								var port = 465;  // SSL port				var mail = require('waf-mail/mail');				var recip = new Array(requestorEmail);				recip.push("PTO_US@4d.com");				//... new mail module end.				//New Mail Module again...				//message body start				messageBody = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">';				messageBody += '<html>';				messageBody += '<head>';				messageBody += '<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />';				messageBody += '<title>PTO Request</title>';				messageBody += '<style type="text/css">';								//messageBody += 'background-color:#B0C4DE;';								messageBody += 'ul {';				messageBody += 'list-style: none;';				messageBody += '}';								messageBody += 'a {';				messageBody += 'text-decoration: none;';				messageBody += 'font-weight: bold;';				messageBody += 'color: #6699CC;';				messageBody += '}';								messageBody += '#wrapDiv {';				messageBody += 'width: 100%;';				messageBody += 'background-color:#FFFFFF;';				messageBody += 'border:1px solid #DFDFDF;';				messageBody += 'padding: 3px;';				messageBody += 'color: #202020;';				messageBody += 'font-size: 14px;';				messageBody += '}';				messageBody += '#bannerDiv {';				messageBody += 'background-color:#B0C4DE;';				messageBody += 'color: #FFFFFF;';				messageBody += 'padding: 5px 30px;';				messageBody += 'font-size:22px;';				messageBody += '}';								messageBody += '#messageDiv {';				messageBody += 'padding: 10px';				messageBody += '}';								messageBody += '#notesDiv {';				messageBody += 'background-color:#F0F8FF;';				messageBody += 'padding: 5px;';				messageBody += 'border: 1px solid gray;';				messageBody += '}';				messageBody += '</style>';				messageBody += '</head>';								messageBody += '<body>';				messageBody += '<div id="wrapDiv">';				messageBody += '<div id="bannerDiv">';				messageBody += '<p>';				messageBody += '4D US - Paid Time Off';				messageBody += '</p>';				messageBody += '</div>';								messageBody += '<div id="messageDiv">';				messageBody += '<p>';				messageBody += theRequestor.fullName;				messageBody += '</p>';								var rejectApproveMessage;				if (status === "rejected") {					rejectApproveMessage = " has rejected your requested time off from ";				} else {					rejectApproveMessage = " has approved your requested time off from ";				}								messageBody += '<p>';				messageBody += '<strong>';				messageBody += myManager.fullName;				messageBody += '</strong>';				messageBody += rejectApproveMessage;				messageBody += firstDayOff + " to " + lastDayOff + ".";				messageBody += '</p>';								messageBody += '<ul>';				var lineItemText;				requestLineItems.forEach(function(lineItem) {					if (lineItem.compensation === "Paid Time Off") {						lineItemText = lineItem.dateRequested + ": " + lineItem.compensation + "  " + lineItem.hoursRequested;					} else {						lineItemText = lineItem.dateRequested + ": " + lineItem.compensation;					}										messageBody += '<li>';					messageBody += lineItemText;					messageBody += '</li>';				});				messageBody += '</ul>';												messageBody += '<div id="notesDiv">';				messageBody += "<p>";				messageBody += notes;				messageBody += "</p>";				messageBody += "</div>";				messageBody += "<p>";								//messageBody += '<a href="http://' + httpServer.hostName + ':' + httpServer.port +'">4D PTO</a>';				messageBody += '<a href="http://' + httpServer.ipAddress + ':' + httpServer.port +'">4D PTO</a>';								messageBody += "</p>";				messageBody += '</div>';								messageBody += '</div>';				messageBody += '</body>';				messageBody += '</head>';				messageBody += '</html>';				//end message body								if (status === "rejected") {					var messageSubject = "PTO Request Rejected";				} else {					var messageSubject = "PTO Request Approved";				}								var mailMessage = new mail.Mail();				mailMessage.setBodyType("text/html");				mailMessage.from = 'wakandaptodemo@gmail.com';				mailMessage.to = recip;				mailMessage.subject = messageSubject;				mailMessage.setBody(messageBody); // that's all				mailMessage.send(address, port , true, username, password);			}						catch (err)			{				//debugger;				new ds.Log({					createDate: new Date(), 					message: err.message,					line: err.line,					name: err.name,					sourceID: err.sourceID,					sourceURL: err.sourceURL				}).save();			}			break;						case "stop":			thePort.postMessage({responseType: "close"});			close();			break;						default:			thePort.postMessage({responseType: "default"});			break;		}				sessionRef.unPromote(promoteToken); //put the session back to normal.    }} //onconnect